<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .active {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema Financeiro</h1>
        
        <div id="errorMessage" class="error"></div>
        <div id="successMessage" class="error" style="background: #d4edda; color: #155724; display: none;"></div>
        
        <div class="card">
            <h2>Status do Sistema</h2>
            <p><strong>Conexão Supabase:</strong> <span id="connectionStatus">Verificando...</span></p>
            <button onclick="testConnection()">Testar Conexão</button>
        </div>
        
        <div class="card">
            <h2>Dados do Usuário</h2>
            <div id="userData" class="loading">Carregando dados do usuário...</div>
            <button onclick="loadUserData()">Recarregar</button>
        </div>
        
        <div class="card">
            <h2>Transações Financeiras</h2>
            <table id="financeTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Conta</th>
                        <th>Cache</th>
                        <th>Último Preço</th>
                        <th>Atualizado em</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" class="loading">Carregando transações...</td></tr>
                </tbody>
            </table>
            <button onclick="loadFinanceData()">Atualizar Dados</button>
            <button onclick="addTransaction()">Nova Transação</button>
        </div>
        
        <div class="card">
            <h2>Backups</h2>
            <table id="backupsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Criado em</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="loading">Carregando backups...</td></tr>
                </tbody>
            </table>
            <button onclick="loadBackups()">Recarregar Backups</button>
            <button onclick="createBackup()">Criar Backup</button>
        </div>
    </div>

    <!-- Biblioteca Supabase (incluída apenas UMA vez) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // =============================================
        // CONFIGURAÇÃO ÚNICA DO SUPABASE
        // =============================================
        
        // Verifica se o Supabase já foi inicializado globalmente
        if (window.supabase && window.supabaseClient) {
            console.log('Supabase já foi inicializado anteriormente');
        } else {
            try {
                // Inicializa o Supabase UMA única vez
                const supabaseUrl = 'https://lebfczoywiqkczppwuwg.supabase.co';
                const supabaseKey = 'SUA_CHAVE_ANON_AQUI'; // Substitua pela sua chave
                
                window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
                window.supabaseClient = window.supabase; // Backup para referência
                
                console.log('Supabase inicializado com sucesso');
                showSuccess('Conexão com Supabase estabelecida');
                
                // Atualiza status de conexão
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="status active">Conectado</span>';
                    
            } catch (error) {
                console.error('Erro ao inicializar Supabase:', error);
                showError('Falha ao conectar com Supabase: ' + error.message);
                document.getElementById('connectionStatus').innerHTML = 
                    '<span style="color: red;">Erro de conexão</span>';
            }
        }
        
        // =============================================
        // FUNÇÕES DE UTILIDADE
        // =============================================
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Oculta após 5 segundos
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            // Oculta após 3 segundos
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
        }
        
        // =============================================
        // FUNÇÕES DE CARREGAMENTO DE DADOS
        // =============================================
        
        async function testConnection() {
            try {
                if (!window.supabase) {
                    throw new Error('Supabase não está inicializado');
                }
                
                // Testa conexão consultando uma tabela
                const { data, error } = await window.supabase
                    .from('user_paths')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                showSuccess('Conexão com Supabase testada com sucesso!');
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="status active">Conectado ✓</span>';
                    
            } catch (error) {
                console.error('Erro no teste de conexão:', error);
                showError('Falha no teste de conexão: ' + error.message);
            }
        }
        
        async function loadUserData() {
            try {
                const userDataDiv = document.getElementById('userData');
                userDataDiv.innerHTML = '<div class="loading">Carregando dados do usuário...</div>';
                
                const { data, error } = await window.supabase
                    .from('user_paths')
                    .select('*')
                    .limit(10);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    let html = '<ul>';
                    data.forEach(user => {
                        html += `
                            <li>
                                <strong>Email:</strong> ${user.email || 'N/A'}<br>
                                <strong>Nome:</strong> ${user.full_name || 'N/A'}<br>
                                <strong>Atualizado:</strong> ${formatDate(user.updated_id)}
                            </li>
                            <hr>
                        `;
                    });
                    html += '</ul>';
                    userDataDiv.innerHTML = html;
                } else {
                    userDataDiv.innerHTML = '<p>Nenhum dado de usuário encontrado</p>';
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                showError('Erro ao carregar dados do usuário: ' + error.message);
            }
        }
        
        async function loadFinanceData() {
            try {
                const tableBody = document.querySelector('#financeTable tbody');
                tableBody.innerHTML = '<tr><td colspan="5" class="loading">Carregando transações...</td></tr>';
                
                const { data, error } = await window.supabase
                    .from('finance_paths')
                    .select('*')
                    .order('updated_id', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    let html = '';
                    data.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.accountin || 'N/A'}</td>
                                <td>${item.cache ? 'Sim' : 'Não'}</td>
                                <td>R$ ${(item.last_price || 0).toFixed(2)}</td>
                                <td>${formatDate(item.updated_id)}</td>
                            </tr>
                        `;
                    });
                    tableBody.innerHTML = html;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5">Nenhuma transação encontrada</td></tr>';
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados financeiros:', error);
                showError('Erro ao carregar transações: ' + error.message);
            }
        }
        
        async function loadBackups() {
            try {
                const tableBody = document.querySelector('#backupsTable tbody');
                tableBody.innerHTML = '<tr><td colspan="4" class="loading">Carregando backups...</td></tr>';
                
                const { data, error } = await window.supabase
                    .from('backlogs')
                    .select('*')
                    .order('created_id', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    let html = '';
                    data.forEach(backup => {
                        html += `
                            <tr>
                                <td>${backup.id}</td>
                                <td>${backup.backup_name || 'Sem nome'}</td>
                                <td>${formatDate(backup.created_id)}</td>
                                <td>
                                    <button onclick="restoreBackup('${backup.id}')">Restaurar</button>
                                    <button onclick="deleteBackup('${backup.id}')">Excluir</button>
                                </td>
                            </tr>
                        `;
                    });
                    tableBody.innerHTML = html;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4">Nenhum backup encontrado</td></tr>';
                }
                
            } catch (error) {
                console.error('Erro ao carregar backups:', error);
                showError('Erro ao carregar backups: ' + error.message);
            }
        }
        
        async function createBackup() {
            try {
                const backupName = prompt('Digite um nome para o backup:', 
                    `Backup_${new Date().toISOString().slice(0, 10)}`);
                
                if (!backupName) return;
                
                // Coleta alguns dados para o backup
                const { data: financeData } = await window.supabase
                    .from('finance_paths')
                    .select('*')
                    .limit(50);
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    finance_records: financeData || [],
                    total_records: financeData ? financeData.length : 0
                };
                
                const { error } = await window.supabase
                    .from('backlogs')
                    .insert({
                        backup_name: backupName,
                        data: backupData,
                        user_id: 1, // ID do usuário atual (ajustar conforme necessário)
                        created_id: new Date().toISOString()
                    });
                
                if (error) throw error;
                
                showSuccess(`Backup "${backupName}" criado com sucesso!`);
                loadBackups();
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                showError('Erro ao criar backup: ' + error.message);
            }
        }
        
        async function addTransaction() {
            try {
                const account = prompt('Nome da conta:');
                if (!account) return;
                
                const price = parseFloat(prompt('Valor:'));
                if (isNaN(price)) return;
                
                const cache = confirm('Armazenar em cache?');
                
                const { error } = await window.supabase
                    .from('finance_paths')
                    .insert({
                        accountin: account,
                        last_price: price,
                        cache: cache,
                        user_id: 1, // ID do usuário atual
                        updated_id: new Date().toISOString(),
                        emailed_id: null
                    });
                
                if (error) throw error;
                
                showSuccess('Transação adicionada com sucesso!');
                loadFinanceData();
                
            } catch (error) {
                console.error('Erro ao adicionar transação:', error);
                showError('Erro ao adicionar transação: ' + error.message);
            }
        }
        
        async function restoreBackup(backupId) {
            if (!confirm('Tem certeza que deseja restaurar este backup?')) return;
            
            try {
                const { data, error } = await window.supabase
                    .from('backlogs')
                    .select('*')
                    .eq('id', backupId)
                    .single();
                
                if (error) throw error;
                
                alert(`Backup "${data.backup_name}" restaurado com sucesso!\n\nDados: ${JSON.stringify(data.data, null, 2)}`);
                showSuccess(`Backup "${data.backup_name}" restaurado`);
                
            } catch (error) {
                console.error('Erro ao restaurar backup:', error);
                showError('Erro ao restaurar backup: ' + error.message);
            }
        }
        
        async function deleteBackup(backupId) {
            if (!confirm('Tem certeza que deseja excluir este backup permanentemente?')) return;
            
            try {
                const { error } = await window.supabase
                    .from('backlogs')
                    .delete()
                    .eq('id', backupId);
                
                if (error) throw error;
                
                showSuccess('Backup excluído com sucesso!');
                loadBackups();
                
            } catch (error) {
                console.error('Erro ao excluir backup:', error);
                showError('Erro ao excluir backup: ' + error.message);
            }
        }
        
        // =============================================
        // INICIALIZAÇÃO DA PÁGINA
        // =============================================
        
        // Carrega todos os dados quando a página é aberta
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página carregada. Inicializando dados...');
            
            // Aguarda um breve momento para garantir que o Supabase esteja carregado
            setTimeout(() => {
                loadUserData();
                loadFinanceData();
                loadBackups();
            }, 1000);
        });
        
        // Tratamento do erro do adsbygoogle (se aplicável)
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('adsbygoogle')) {
                console.log('Anúncio bloqueado - pode ser ignorado');
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
